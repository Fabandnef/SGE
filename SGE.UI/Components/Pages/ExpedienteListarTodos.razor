@page "/expediente/listar/{Page:int?}"

@using SGE.Aplicacion.CasosDeUso
@using SGE.Aplicacion.Entidades
@using SGE.Aplicacion.Enumerativos
@using SGE.Aplicacion.Excepciones
@using SGE.Aplicacion.Interfaces.Repositorios

@inject NavigationManager               NavigationManager
@inject Session                         CurrentSession
@inject ExpedienteAltaCasoDeUso         _expedienteAltaCasoDeUso
@inject ExpedienteListarCasoDeUso       _expedienteListarCasoDeUso
@inject ExpedienteContarTotalCasoDeUso  _expedienteContarTotalCasoDeUso
@inject ExpedienteBajaCasoDeUso         _expedienteBajaCasoDeUso
@inject IRepositorioUsuario             _repositorioUsuario
@inject Usuario                         _usuario

<section class="bg-gray-50 dark:bg-gray-900 p-3 sm:p-5">
    <div class="mx-auto max-w-screen-xl px-4 lg:px-12">
        <!-- Start coding here -->
        <div class="bg-white dark:bg-gray-800 relative shadow-md sm:rounded-lg overflow-hidden">
            <div class="flex flex-col md:flex-row items-center justify-between space-y-3 md:space-y-0 md:space-x-4 p-4">
                <div class="w-full md:w-1/2">
                    <form class="flex items-center">
                        <label class="sr-only" for="simple-search">Buscar</label>
                        <div class="relative w-full">
                            <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                                <svg aria-hidden="true" class="w-5 h-5 text-gray-500 dark:text-gray-400" fill="currentColor" viewbox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                                    <path clip-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" fill-rule="evenodd"/>
                                </svg>
                            </div>
                            <input class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full pl-10 p-2 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-primary-500 dark:focus:border-primary-500" id="simple-search" placeholder="Buscar..." required="" type="text">
                        </div>
                    </form>
                </div>
                <div class="w-full md:w-auto flex flex-col md:flex-row space-y-2 md:space-y-0 items-stretch md:items-center justify-end md:space-x-3 flex-shrink-0">
                    <a class="flex items-center justify-center text-white bg-primary-700 hover:bg-primary-800 focus:ring-4 focus:ring-primary-300 font-medium rounded-lg text-sm px-4 py-2 dark:bg-primary-600 dark:hover:bg-primary-700 focus:outline-none dark:focus:ring-primary-800" 
                       href="/expediente/crear" type="button">
                        <i class="fa fa-duotone fa-plus fa-lg pe-3"></i>
                        Agregar expediente
                    </a>
                    <div class="flex items-center space-x-3 w-full md:w-auto">
                        <button class="w-full md:w-auto flex items-center justify-center py-2 px-4 text-sm font-medium text-gray-900 focus:outline-none bg-white rounded-lg border border-gray-200 hover:bg-gray-100 hover:text-primary-700 focus:z-10 focus:ring-4 focus:ring-gray-200 dark:focus:ring-gray-700 dark:bg-gray-800 dark:text-gray-400 dark:border-gray-600 dark:hover:text-white dark:hover:bg-gray-700" data-dropdown-toggle="filterDropdown" id="filterDropdownButton" type="button">
                            <svg aria-hidden="true" class="h-4 w-4 mr-2 text-gray-400" fill="currentColor" viewbox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                                <path clip-rule="evenodd" d="M3 3a1 1 0 011-1h12a1 1 0 011 1v3a1 1 0 01-.293.707L12 11.414V15a1 1 0 01-.293.707l-2 2A1 1 0 018 17v-5.586L3.293 6.707A1 1 0 013 6V3z" fill-rule="evenodd"/>
                            </svg>
                            Filtrar por estado
                            <svg aria-hidden="true" class="-mr-1 ml-1.5 w-5 h-5" fill="currentColor" viewbox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                                <path clip-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" fill-rule="evenodd"/>
                            </svg>
                        </button>
                        <div class="z-10 hidden w-48 p-3 bg-white rounded-lg shadow dark:bg-gray-700" id="filterDropdown">
                            <ul aria-labelledby="filterDropdownButton" class="space-y-2 text-sm">
                                <li class="flex items-center">
                                    <input class="w-4 h-4 bg-gray-100 border-gray-300 rounded text-primary-600 focus:ring-primary-500 dark:focus:ring-primary-600 dark:ring-offset-gray-700 focus:ring-2 dark:bg-gray-600 dark:border-gray-500" id="apple" type="checkbox" value="">
                                    <label class="ml-2 text-sm font-medium text-gray-900 dark:text-gray-100" for="apple">Apple (56)</label>
                                </li>
                                <li class="flex items-center">
                                    <input class="w-4 h-4 bg-gray-100 border-gray-300 rounded text-primary-600 focus:ring-primary-500 dark:focus:ring-primary-600 dark:ring-offset-gray-700 focus:ring-2 dark:bg-gray-600 dark:border-gray-500" id="fitbit" type="checkbox" value="">
                                    <label class="ml-2 text-sm font-medium text-gray-900 dark:text-gray-100" for="fitbit">Microsoft (16)</label>
                                </li>
                                <li class="flex items-center">
                                    <input class="w-4 h-4 bg-gray-100 border-gray-300 rounded text-primary-600 focus:ring-primary-500 dark:focus:ring-primary-600 dark:ring-offset-gray-700 focus:ring-2 dark:bg-gray-600 dark:border-gray-500" id="razor" type="checkbox" value="">
                                    <label class="ml-2 text-sm font-medium text-gray-900 dark:text-gray-100" for="razor">Razor (49)</label>
                                </li>
                                <li class="flex items-center">
                                    <input class="w-4 h-4 bg-gray-100 border-gray-300 rounded text-primary-600 focus:ring-primary-500 dark:focus:ring-primary-600 dark:ring-offset-gray-700 focus:ring-2 dark:bg-gray-600 dark:border-gray-500" id="nikon" type="checkbox" value="">
                                    <label class="ml-2 text-sm font-medium text-gray-900 dark:text-gray-100" for="nikon">Nikon (12)</label>
                                </li>
                                <li class="flex items-center">
                                    <input class="w-4 h-4 bg-gray-100 border-gray-300 rounded text-primary-600 focus:ring-primary-500 dark:focus:ring-primary-600 dark:ring-offset-gray-700 focus:ring-2 dark:bg-gray-600 dark:border-gray-500" id="benq" type="checkbox" value="">
                                    <label class="ml-2 text-sm font-medium text-gray-900 dark:text-gray-100" for="benq">BenQ (74)</label>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            <div class="overflow-x-auto">
                <div class="w-full text-sm text-left text-gray-500 dark:text-gray-400">
                    <div class="flex text-xs font-bold text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400">
                        <div class="px-4 py-3 w-3/12" scope="col">Carátula</div>
                        <div class="px-4 py-3 w-2/12" scope="col">Estado</div>
                        <div class="px-4 py-3 w-2/12" scope="col">Último usuario</div>
                        <div class="px-4 py-3 w-2/12 hidden lg:inline" scope="col">Creado</div>
                        <div class="px-4 py-3 w-2/12 hidden 2xl:inline" scope="col">Última edición</div>
                        <div class="px-4 py-3 w-5/12 lg:w-3/12 2xl:w-1/12" scope="col">
                            <span class="sr-only">Acciones</span>
                        </div>
                    </div>
                    @if (_expedientes.Count == 0) {
                        <div class="border-b dark:border-gray-700">
                            <div class="px-4 py-3 text-center">No hay expedientes para mostrar</div>
                        </div>
                    } else {
                        @foreach (Expediente e in _expedientes) {
                            <div class="flex border-b dark:border-gray-700 cursor-default">
                                <div class="px-4 py-3 font-medium text-gray-900 whitespace-nowrap dark:text-white w-3/12 truncate overflow-ellipsis" scope="row">
                                    <span class="align-middle" title="@e.Caratula">@e.Caratula</span>
                                </div>
                                <div class="px-4 py-3 w-2/12 truncate overflow-ellipsis">
                                    <span class="align-middle" title="@Enum.GetName(typeof(EstadoExpediente), e.Estado)">@Enum.GetName(typeof(EstadoExpediente), e.Estado)</span>
                                </div>
                                <div class="px-4 py-3 w-2/12 truncate overflow-ellipsis">
                                    <span class="align-middle" title="@(e.UsuarioUltimaModificacion.NombreCompleto)">@(e.UsuarioUltimaModificacion.NombreCompleto)</span>
                                </div>
                                <div class="px-4 py-3 w-2/12 truncate overflow-ellipsis hidden lg:inline">
                                    <span class="align-middle">@e.CreatedAt</span>
                                </div>
                                <div class="px-4 py-3 w-2/12 truncate overflow-ellipsis hidden 2xl:inline">
                                    <span class="align-middle">@e.UpdatedAt</span>
                                </div>
                                <div class="px-4 py-2 gap-1 w-5/12 lg:w-3/12 2xl:w-1/12 flex justify-end">
                                    <button class="min-w-9 max-w-9 items-center py-1 px-2 text-sm font-medium border bg-green-500 border-green-600 dark:bg-green-900 dark:border-green-800 bg-opacity-25 dark:bg-opacity-25 text-center text-gray-500 hover:text-gray-800 rounded-lg focus:outline-none dark:text-gray-400 dark:hover:text-gray-100"
                                            id="view-expediente-@e.Id"
                                            @onclick="() => VerExpediente(e)" type="button">
                                        <i class="fa fa-duotone fa-eye fa-lg"></i>
                                    </button>
                                    <button class="min-w-9 max-w-9 items-center py-1 px-2 text-sm font-medium border bg-amber-500 border-amber-600 dark:bg-amber-700 dark:border-amber-600 bg-opacity-25 dark:bg-opacity-25 text-center text-gray-500 hover:text-gray-800 rounded-lg focus:outline-none dark:text-gray-400 dark:hover:text-gray-100"
                                            id="view-expediente-@e.Id"
                                            @onclick="() => EditarExpediente(e)" type="button">
                                        <i class="fa fa-duotone fa-pencil fa-lg"></i>
                                    </button>
                                    <button class="min-w-9 max-w-9 items-center py-1 px-2 text-sm font-medium border bg-red-500 border-red-600 dark:bg-red-700 dark:border-red-600 bg-opacity-25 dark:bg-opacity-25 text-center text-gray-500 hover:text-gray-800 rounded-lg focus:outline-none dark:text-gray-400 dark:hover:text-gray-100"
                                            id="view-expediente-@e.Id"
                                            @onclick="() => EliminarExpediente(e)" type="button">
                                        <i class="fa fa-duotone fa-trash fa-lg"></i>
                                    </button>
                                </div>
                            </div>
                        }
                    }
                </div>
            </div>
            <nav aria-label="Table navigation" class="flex flex-col md:flex-row justify-between items-start md:items-center space-y-3 md:space-y-0 p-4">
                <span class="text-sm font-normal text-gray-500 dark:text-gray-400">
                    Mostrando
                    <span class="font-semibold text-gray-900 dark:text-white">@(((_page - 1) * 10) + 1 > 0 ? ((_page - 1) * 10) + 1 : "0") - @((_page * 10) < _totalExpedientes ? _page * 10 : _totalExpedientes)</span>
                    de
                    <span class="font-semibold text-gray-900 dark:text-white">@_totalExpedientes</span>
                </span>
                @if (_totalPages > 1) {
                    <ul class="inline-flex items-stretch -space-x-px">
                        <li>
                            <div class="flex cursor-pointer items-center justify-center h-full py-1.5 px-3 ml-0 text-gray-500 bg-white rounded-l-lg border border-gray-300 hover:bg-gray-100 hover:text-gray-700 dark:bg-gray-800 dark:border-gray-700 dark:text-gray-400 dark:hover:bg-gray-700 dark:hover:text-white"
                                 href="#" @onclick="PreviousPage">
                                <span class="sr-only">Anterior</span>
                                <svg aria-hidden="true" class="w-5 h-5" fill="currentColor" viewbox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                                    <path clip-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" fill-rule="evenodd"/>
                                </svg>
                            </div>
                        </li>
                        @for (int i = 1; i <= Math.Min(_totalPages, 5); i++) {
                            if (i == _page) {
                                <li>
                                    <a class="flex items-center justify-center text-sm z-10 py-2 px-3 leading-tight text-primary-600 bg-primary-50 border border-primary-300 hover:bg-primary-100 hover:text-primary-700 dark:border-gray-700 dark:bg-gray-700 dark:text-white" href="@($"/expediente/listar/{i}")">@i</a>
                                </li>
                            } else {
                                <li>
                                    <a class="flex items-center justify-center text-sm py-2 px-3 leading-tight text-gray-500 bg-white border border-gray-300 hover:bg-gray-100 hover:text-gray-700 dark:bg-gray-800 dark:border-gray-700 dark:text-gray-400 dark:hover:bg-gray-700 dark:hover:text-white" href="@($"/expediente/listar/{i}")">@i</a>
                                </li>
                            }
                        }
                        <li>
                            <div class="flex cursor-pointer items-center justify-center h-full py-1.5 px-3 leading-tight text-gray-500 bg-white rounded-r-lg border border-gray-300 hover:bg-gray-100 hover:text-gray-700 dark:bg-gray-800 dark:border-gray-700 dark:text-gray-400 dark:hover:bg-gray-700 dark:hover:text-white"
                                 href="#" @onclick="NextPage">
                                <span class="sr-only">Siguiente</span>
                                <svg aria-hidden="true" class="w-5 h-5" fill="currentColor" viewbox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                                    <path clip-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" fill-rule="evenodd"/>
                                </svg>
                            </div>
                        </li>
                    </ul>
                }
            </nav>
        </div>
    </div>
</section>

@code {

    [Parameter] public int? Page { get; set; } = 1;

    private List<Expediente> _expedientes      = [];
    private int              _totalExpedientes = 0;
    private string           _error            = "";
    private int              _page             = 0;
    private int              _totalPages       = 0;
    private bool             _hasPreviousPage => _page > 1;
    private bool             _hasNextPage     => _page < _totalPages;

    protected override void OnInitialized() {
        try {
            _totalExpedientes = _expedienteContarTotalCasoDeUso.Ejecutar();
            _totalPages       = (int)Math.Ceiling((double)_totalExpedientes / 10);
            _page             = Page ?? 1;
            _expedientes      = _expedienteListarCasoDeUso.Ejecutar(_page);
        } catch (Exception e) {
            _error = e.Message;
        }
    }

    protected override void OnParametersSet() {
        try {
            _page = Page ?? 1;

            if (_page > _totalPages) {
                NavigationManager.NavigateTo($"/expediente/listar/{_totalPages}");
            }

            _expedientes = _expedienteListarCasoDeUso.Ejecutar(_page);
        } catch (RepositorioException e) {
            _error = e.Message;
        }
    }

    private void NextPage() {
        if (!_hasNextPage) return;

        Page = _page + 1;
        NavigationManager.NavigateTo($"/expediente/listar/{Page}");
    }

    private void PreviousPage() {
        if (!_hasPreviousPage) return;

        Page = _page - 1;
        NavigationManager.NavigateTo($"/expediente/listar/{Page}");
    }

    private void VerExpediente(Expediente expediente) {
        NavigationManager.NavigateTo($"/expediente/{expediente.Id}");
    }

    private void EditarExpediente(Expediente expediente) {
        NavigationManager.NavigateTo($"/expediente/editar/{expediente.Id}");
    }

    private void EliminarExpediente(Expediente expediente) {
        try {
            _expedienteBajaCasoDeUso.Ejecutar(expediente.Id, CurrentSession.Usuario!);
            InvokeAsync(StateHasChanged);
        } catch (RepositorioException e) {
            _error = e.Message;
        } catch (AutorizacionException e) {
            _error = e.Message;
        } finally {
            InvokeAsync(StateHasChanged);
        }
    }

}